import{R as v,r as w,j as s,Y as Z,y as G,b as f}from"./app-WkCQ_0mE.js";import{A as I}from"./AuthenticatedLayout-CvNJQ03m.js";import{o as $,q as ee,c as te,a as ne,b as ae,d as E,e as N,u as R,g as _,f as F}from"./firebase-UxZUsInj.js";import oe from"./Modal-c980BGSn.js";import re from"./Spinner-BetlNvTM.js";import"./Dropdown-BuLuLwFS.js";import"./transition-D7_gyUx8.js";var W={color:void 0,size:void 0,className:void 0,style:void 0,attr:void 0},M=v.createContext&&v.createContext(W),se=["attr","size","title"];function le(e,t){if(e==null)return{};var n=ie(e,t),a,d;if(Object.getOwnPropertySymbols){var u=Object.getOwnPropertySymbols(e);for(d=0;d<u.length;d++)a=u[d],!(t.indexOf(a)>=0)&&Object.prototype.propertyIsEnumerable.call(e,a)&&(n[a]=e[a])}return n}function ie(e,t){if(e==null)return{};var n={};for(var a in e)if(Object.prototype.hasOwnProperty.call(e,a)){if(t.indexOf(a)>=0)continue;n[a]=e[a]}return n}function S(){return S=Object.assign?Object.assign.bind():function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var a in n)Object.prototype.hasOwnProperty.call(n,a)&&(e[a]=n[a])}return e},S.apply(this,arguments)}function q(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter(function(d){return Object.getOwnPropertyDescriptor(e,d).enumerable})),n.push.apply(n,a)}return n}function O(e){for(var t=1;t<arguments.length;t++){var n=arguments[t]!=null?arguments[t]:{};t%2?q(Object(n),!0).forEach(function(a){ce(e,a,n[a])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):q(Object(n)).forEach(function(a){Object.defineProperty(e,a,Object.getOwnPropertyDescriptor(n,a))})}return e}function ce(e,t,n){return t=ge(t),t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function ge(e){var t=me(e,"string");return typeof t=="symbol"?t:t+""}function me(e,t){if(typeof e!="object"||!e)return e;var n=e[Symbol.toPrimitive];if(n!==void 0){var a=n.call(e,t||"default");if(typeof a!="object")return a;throw new TypeError("@@toPrimitive must return a primitive value.")}return(t==="string"?String:Number)(e)}function B(e){return e&&e.map((t,n)=>v.createElement(t.tag,O({key:n},t.attr),B(t.child)))}function T(e){return t=>v.createElement(de,S({attr:O({},e.attr)},t),B(e.child))}function de(e){var t=n=>{var{attr:a,size:d,title:u}=e,P=le(e,se),p=d||n.size||"1em",h;return n.className&&(h=n.className),e.className&&(h=(h?h+" ":"")+e.className),v.createElement("svg",S({stroke:"currentColor",fill:"currentColor",strokeWidth:"0"},n.attr,a,P,{className:h,style:O(O({color:e.color||n.color},n.style),e.style),height:p,width:p,xmlns:"http://www.w3.org/2000/svg"}),u&&v.createElement("title",null,u),e.children)};return M!==void 0?v.createElement(M.Consumer,null,n=>t(n)):t(W)}function fe(e){return T({tag:"svg",attr:{viewBox:"0 0 1024 1024"},child:[{tag:"path",attr:{d:"M705.6 124.9a8 8 0 0 0-11.6 7.2v64.2c0 5.5 2.9 10.6 7.5 13.6a352.2 352.2 0 0 1 62.2 49.8c32.7 32.8 58.4 70.9 76.3 113.3a355 355 0 0 1 27.9 138.7c0 48.1-9.4 94.8-27.9 138.7a355.92 355.92 0 0 1-76.3 113.3 353.06 353.06 0 0 1-113.2 76.4c-43.8 18.6-90.5 28-138.5 28s-94.7-9.4-138.5-28a353.06 353.06 0 0 1-113.2-76.4A355.92 355.92 0 0 1 184 650.4a355 355 0 0 1-27.9-138.7c0-48.1 9.4-94.8 27.9-138.7 17.9-42.4 43.6-80.5 76.3-113.3 19-19 39.8-35.6 62.2-49.8 4.7-2.9 7.5-8.1 7.5-13.6V132c0-6-6.3-9.8-11.6-7.2C178.5 195.2 82 339.3 80 506.3 77.2 745.1 272.5 943.5 511.2 944c239 .5 432.8-193.3 432.8-432.4 0-169.2-97-315.7-238.4-386.7zM480 560h64c4.4 0 8-3.6 8-8V88c0-4.4-3.6-8-8-8h-64c-4.4 0-8 3.6-8 8v464c0 4.4 3.6 8 8 8z"},child:[]}]})(e)}function ue(e){return T({tag:"svg",attr:{t:"1569683742680",viewBox:"0 0 1024 1024",version:"1.1"},child:[{tag:"defs",attr:{},child:[]},{tag:"path",attr:{d:"M931.4 498.9L94.9 79.5c-3.4-1.7-7.3-2.1-11-1.2-8.5 2.1-13.8 10.7-11.7 19.3l86.2 352.2c1.3 5.3 5.2 9.6 10.4 11.3l147.7 50.7-147.6 50.7c-5.2 1.8-9.1 6-10.3 11.3L72.2 926.5c-0.9 3.7-0.5 7.6 1.2 10.9 3.9 7.9 13.5 11.1 21.5 7.2l836.5-417c3.1-1.5 5.6-4.1 7.2-7.1 3.9-8 0.7-17.6-7.2-21.6zM170.8 826.3l50.3-205.6 295.2-101.3c2.3-0.8 4.2-2.6 5-5 1.4-4.2-0.8-8.7-5-10.2L221.1 403 171 198.2l628 314.9-628.2 313.2z"},child:[]}]})(e)}function je({auth:e,gameId:t,gameCode:n}){var z;const[a,d]=w.useState([]),[u,P]=w.useState(""),[p,h]=w.useState(0),U=window.location.origin,[c,k]=w.useState(null),[J,C]=w.useState(!1),[D,V]=w.useState(""),[Y,j]=w.useState(!1);let r="";w.useEffect(()=>{const g=$(ae,o=>{var L;k(o),console.log("User set on Auth State Changed in Game:",o);const m=async()=>{if(!t){console.log("No game id found on Auth State Changed in Game when fetching players.");return}if(!r){console.log("No user email found in Game when fetching players on Auth State Changed.");return}try{const i=await f.get(`/api/game/${t}/${r}/players`);i.data.players==="No players. Game room not found."&&console.log("No players. Game room not found."),i.data.players.some(x=>x.email===r)||console.log("User had left the game on Auth State Changed."),d(i.data.players),console.log("Users fetched successfully in Game page on Auth State Changed:",i.data.players)}catch(i){console.log("Error fetching players in Game page on Auth State Changed:",i)}},l=async()=>{if(!t){console.log("No gameId found in Game when fetching round on Auth State Changed.");return}if(!r){console.log("No user email found in Game when fetching round on Auth State Changed.");return}try{const i=await f.post(`/api/round/${t}/${r}`);i.data.round&&(h(i.data.round),console.log("Round fetched successfully in Game page on Auth State Changed:",i.data.round))}catch(i){console.log("Error fetching players on Auth State Changed in Game page:",i)}},y=ee(te(N,"gameRooms"));ne(y,async i=>{try{const x=await f.post(`/api/game/${r}`);x.data.players?(console.log("Players fetched successfully in Game page on Firebase Changed:",x.data.players),x.data.players.some(X=>X.email===r)||(console.log("You are not in this game",x.data.players),G.visit("/"))):(console.log("Players not fetched in Game page on Firebase Changed:",x.data.players),G.visit("/"))}catch(x){console.log("Error fetching players on Firebase Changed in Game page:",x),G.visit("/",{data:{inviteGameCode:n}})}console.log("Change in firebase detected in Game page on Auth State Changed:",i),m(),l()}),r=((L=e==null?void 0:e.user)==null?void 0:L.email)||(o==null?void 0:o.email)||"",r||(console.log("No user email found in Game when fetching players on Auth State Changed. Redirecting to login..."),G.visit("/login")),(async()=>{if(!r){console.log("No user email found in Game when fetching фвьшт on Auth State Changed.");return}try{const i=await f.get(`/api/game/${r}/admin`);P(i.data),console.log("Admin fetched successfully in Game page on Auth State Changed:",i.data)}catch(i){console.log("Error fetching players on Auth State Changed:",i)}})(),m(),l()});return()=>g()},[]),w.useEffect(()=>{(async()=>{if(!t){console.log("No gameId found in Game when fetching players on page load.");return}if(!r){console.log("No user email found in Game when fetching players on page load.");return}try{const l=await f.get(`/api/game/${t}/${c==null?void 0:c.email}/players`);d(l.data.players),console.log("Players feetched successfully on page load in Game page:",l.data.players)}catch(l){console.log("Error fetching players on page load i n Game page:",l)}})(),(async()=>{if(!t){console.log("No gameId found in Game when fetching round on page load.");return}if(!r){console.log("No user email found in Game when fetching round on page load.");return}try{const l=await f.post(`/api/round/${t}/${c==null?void 0:c.email}`);l.data.round&&(h(l.data.round),console.log("Round fetched successfully on page load in Game page:",l.data.round))}catch(l){console.log("Error fetching players on page load in game page:",l)}})();const m=async()=>{try{const l=await f.post(`/api/location/${t}/${r}`),y=a.find(b=>b.email===r)}catch{console.log("Error fetching player's location")}};p>0&&m()},[p]);const K=async()=>{var g;if(r=((g=e==null?void 0:e.user)==null?void 0:g.email)||(c==null?void 0:c.email)||"",!t){console.log("No gameId found in Game when starting new round.");return}if(!r){console.log("No user email found in Game when starting new round.");return}j(!0);try{const o=await f.post(`/api/games/${t}/${r}/${p+1}/rounds`);d(o.data.players),h(p+1),console.log("New round started successfully in Game page:",o.data.players);try{const m=E(N,"gameRooms",t);await R(m,{round:p+1}),console.log("New round started successfully in Firebase in Game page:",o.data.players)}catch(m){console.log("Error setting round for game in firebase after starting new round :",m)}}catch(o){console.log("Error starting new round in Game page:",o)}finally{j(!1)}},H=async()=>{var g;if(r=((g=e==null?void 0:e.user)==null?void 0:g.email)||(c==null?void 0:c.email)||"",!t){console.log("No gameId found in Game when leaving game.");return}if(!r){console.log("No user email found in Game when leaving game.");return}j(!0);try{await f.delete(`/api/game/${t}/${r}/leave`),console.log("Left game successfully in Game page:",t);try{const o=E(N,"gameRooms",t),m=await _(o);if(m.exists()){const l=m.data().players||[],y=l.indexOf(r);if(y!==-1){const b=[...l.slice(0,y),...l.slice(y+1)];await R(o,{players:b}),u.isAdmin&&await F(o),console.log("Player removed from the game in Firebase successfully on leaving game"),b.length===0&&(await F(o),console.log("Game document deleted as there are no more players on leaving game"))}else console.log("Player does not exist in the game on leaving game")}else console.log("Game document does not exist on leaving game")}catch(o){console.log("Error removing player from game on leaving game:",o)}G.visit("/")}catch(o){console.log("Error leaving game:",o)}finally{j(!1)}},Q=async g=>{if(g.preventDefault(),!n){console.log("No game code found in Game when joining game from Game page.");return}if(!r){console.log("No user email found in Game when joining game from Game page.");return}j(!0);try{const o=await f.post("/api/join-game",{gameCode:n,userEmail:r});console.log("Successfully joined the game from Game page:",o.data);const m=E(N,"gameRooms",o.data.gameId.toString()),l=await _(m);if(l.exists()){const y=l.data().players||[];if(y.includes(r))console.log("User already exists in the game when joining game from Game page");else{const b=[...y,r];await R(m,{players:b}),console.log("User added to the game in Firebase successfully when joining game from Game page")}}else console.log("Game document does not exist when joining game from Game page");G.visit(`/game/${o.data.gameId}/${o.data.gameCode}`)}catch(o){o.response?(console.log("Error response when joining game from Game page:",o.response.data),V(o.response.data.error||"Unknown error")):o.request?console.log("Error request when joining game from Game page:",o.request):console.log("Error message when joining game from Game page:",o.message)}finally{j(!1)}};r=((z=e==null?void 0:e.user)==null?void 0:z.email)||(c==null?void 0:c.email)||"";const A=()=>a.some(g=>g.email===r);return s.jsxs(I,{user:(e==null?void 0:e.user)||(c==null?void 0:c.displayName),children:[s.jsx(Z,{title:"Spy Online"}),s.jsxs("div",{className:"max-w-4xl mx-auto px-4 py-8 flex flex-col justify-center items-center bg-background",children:[s.jsxs("h1",{className:"text-3xl text-brightyellow font-bold mb-4",children:["Game ",n]}),s.jsx("img",{className:"w-48 rounded-full",src:`${U}/android-chrome-512x512.png`,alt:"Logo"}),s.jsxs("h2",{className:"text-xl text-brightyellow font-semibold mb-4",children:["Round: ",p]}),a.length<3&&s.jsx("h2",{className:"text-sm text-brightyellow italic mb-4",children:"Waiting for players. There must be three of them at least to start a new game or round."}),s.jsxs("div",{className:"max-w-4xl mx-auto flex justify-center items-center",children:[u.isAdmin&&a.length>2&&A()&&s.jsx("button",{onClick:K,className:"bg-brightgreen text-white px-4 py-2 rounded-md mr-4",children:s.jsx(ue,{})}),A()&&s.jsx("button",{onClick:()=>C(!0),className:"bg-red-500 text-white px-4 py-2 rounded-md",children:s.jsx(fe,{})}),!A()&&s.jsxs("div",{className:"FormContainer mb-8",children:[s.jsxs("form",{className:"flex flex-col justify-center items-center",onSubmit:Q,children:[s.jsx("label",{className:"block mb-2 flex flex-col justify-center items-center"}),s.jsx("button",{className:"bg-brightpurple text-brightyellow py-2 px-4 rounded-md hover:bg-darkpurple focus:outline-none",type:"submit",children:"Join Game"})]}),D&&s.jsx("p",{className:"mt-2 text-center text-red-500",children:D})]})]}),s.jsx("div",{className:"mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:a.map(g=>s.jsxs("div",{className:"",children:[s.jsxs("h2",{className:"text-lg text-center text-brightyellow font-semibold mb-2",children:[g.name," ",g.role==="administrator"&&s.jsx("span",{className:"text-sm text-brightgreen",children:"(Admin)"})]}),s.jsx("p",{className:"text-center text-red-500",children:g.location})]},g.id))})]}),Y&&s.jsx(re,{}),s.jsx(oe,{isOpen:J,onClose:()=>C(!1),onConfirm:()=>{C(!1),H()},title:"Confirm Leave Game",message:s.jsxs("span",{children:["Are you sure you want to leave the game?",u.isAdmin&&s.jsx("span",{children:" As you are the admin the game will be deleted."})]})})]})}export{je as default};
